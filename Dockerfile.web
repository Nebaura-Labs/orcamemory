FROM oven/bun:1.3.2

WORKDIR /app

# Copy package files first for better caching
COPY package.json bun.lock* ./
COPY apps/web/package.json ./apps/web/
COPY packages/config/package.json ./packages/config/
COPY packages/env/package.json ./packages/env/
COPY packages/backend/package.json ./packages/backend/

# Install dependencies
RUN bun install

# Copy the rest of the monorepo
COPY . .

# Build the web app
RUN bun --cwd apps/web run build

EXPOSE 3000

# Use a production-ready static server instead of vite preview
RUN bun add -g serve

CMD ["serve", "-s", "apps/web/dist", "-l", "3000"]
