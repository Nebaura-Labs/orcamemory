version: '3.8'

services:
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: convex-backend
    restart: unless-stopped
    volumes:
      - convex-data:/convex/data
    environment:
      - INSTANCE_NAME=${INSTANCE_NAME:-self-hosted-convex}
      - INSTANCE_SECRET=${INSTANCE_SECRET}
      - CONVEX_CLOUD_ORIGIN=https://orca-convex.jonahships.com
      - CONVEX_SITE_ORIGIN=http://91.98.137.199:3211
      - DO_NOT_REQUIRE_SSL=true
      - DISABLE_BEACON=false
      - REDACT_LOGS_TO_CLIENT=false
      - RUST_LOG=info
    networks:
      - coolify
      - convex-internal
    labels:
      # API endpoint (port 3210) - orca-db.jonahships.com
      - "traefik.enable=true"
      - "traefik.http.routers.convex-api.rule=Host(`orca-db.jonahships.com`)"
      - "traefik.http.routers.convex-api.entrypoints=websecure"
      - "traefik.http.routers.convex-api.tls=true"
      - "traefik.http.routers.convex-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.convex-api.service=convex-api"
      - "traefik.http.services.convex-api.loadbalancer.server.port=3210"
      
      # HTTP Actions endpoint (port 3211) - different router
      - "traefik.http.routers.convex-site.rule=Host(`orca-db.jonahships.com`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.convex-site.entrypoints=websecure"
      - "traefik.http.routers.convex-site.tls=true"
      - "traefik.http.routers.convex-site.tls.certresolver=letsencrypt"
      - "traefik.http.routers.convex-site.service=convex-site"
      - "traefik.http.routers.convex-site.priority=100"
      - "traefik.http.services.convex-site.loadbalancer.server.port=3211"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:3210/version']
      interval: 5s
      start_period: 10s

  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    container_name: convex-dashboard
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=https://orca-db.jonahships.com
    depends_on:
      convex-backend:
        condition: service_healthy
    networks:
      - coolify
      - convex-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.convex-dashboard.rule=Host(`orca-convex.jonahships.com`)"
      - "traefik.http.routers.convex-dashboard.entrypoints=websecure"
      - "traefik.http.routers.convex-dashboard.tls=true"
      - "traefik.http.routers.convex-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.services.convex-dashboard.loadbalancer.server.port=6791"
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://127.0.0.1:6791/']
      interval: 5s
      start_period: 5s

networks:
  coolify:
    external: true
  convex-internal:
    driver: bridge

volumes:
  convex-data:
    driver: local
